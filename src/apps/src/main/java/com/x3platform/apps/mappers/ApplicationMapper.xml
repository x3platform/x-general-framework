<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.x3platform.apps.mappers.ApplicationMapper" >
  <resultMap id="findOne_Result" type="com.x3platform.apps.models.ApplicationInfo">
    <result property="Id" column="Id" />
    <result property="AccountId" column="AccountId" />
    <result property="ParentId" column="ParentId" />
    <result property="Code" column="Code" />
    <result property="ApplicationName" column="ApplicationName" />
    <result property="ApplicationDisplayName" column="ApplicationDisplayName" />
    <result property="ApplicationKey" column="ApplicationKey" />
    <result property="ApplicationSecret" column="ApplicationSecret" />
    <result property="PinYin" column="PinYin" />
    <result property="Description" column="Description" />
    <result property="HasChildren" column="HasChildren" />
    <result property="AdministratorEmail" column="AdministratorEmail" />
    <result property="IconPath" column="IconPath" />
    <result property="BigIconPath" column="BigIconPath" />
    <result property="HelpUrl" column="HelpUrl" />
    <result property="LicenseStatus" column="LicenseStatus" />
    <result property="Hidden" column="Hidden" />
    <result property="Locking" column="Locking" />
    <result property="OrderId" column="OrderId" />
    <result property="Status" column="Status" />
    <result property="Remark" column="Remark" />
    <result property="ModifiedDate" column="ModifiedDate" />
    <result property="CreatedDate" column="CreatedDate" />
  </resultMap>
  <resultMap id="FindAll_Result" type="com.x3platform.apps.models.ApplicationInfo">
    <result property="Id" column="Id" />
    <result property="AccountId" column="AccountId" />
    <result property="ParentId" column="ParentId" />
    <result property="Code" column="Code" />
    <result property="ApplicationName" column="ApplicationName" />
    <result property="ApplicationDisplayName" column="ApplicationDisplayName" />
    <result property="ApplicationKey" column="ApplicationKey" />
    <result property="ApplicationSecret" column="ApplicationSecret" />
    <result property="PinYin" column="PinYin" />
    <result property="Description" column="Description" />
    <result property="HasChildren" column="HasChildren" />
    <result property="AdministratorEmail" column="AdministratorEmail" />
    <result property="IconPath" column="IconPath" />
    <result property="BigIconPath" column="BigIconPath" />
    <result property="HelpUrl" column="HelpUrl" />
    <result property="LicenseStatus" column="LicenseStatus" />
    <result property="Hidden" column="Hidden" />
    <result property="Locking" column="Locking" />
    <result property="OrderId" column="OrderId" />
    <result property="Status" column="Status" />
    <result property="Remark" column="Remark" />
    <result property="ModifiedDate" column="ModifiedDate" />
    <result property="CreatedDate" column="CreatedDate" />
  </resultMap>
  <insert id="Insert" parameterType="com.x3platform.apps.models.ApplicationInfo" >
    INSERT INTO tb_Application
    (
    Id,
    AccountId,
    ParentId,
    Code,
    ApplicationName,
    ApplicationDisplayName,
    ApplicationKey,
    ApplicationSecret,
    PinYin,
    Description,
    AdministratorEmail
    IconPath,
    BigIconPath,
    HelpUrl,
    LicenseStatus,
    Hidden,
    Locking,
    OrderId,
    Status,
    Remark,
    ModifiedDate,
    CreatedDate
    )
    VALUES
    (
    #Id#,
    #AccountId#,
    #ParentId#,
    #Code#,
    #ApplicationName#,
    #ApplicationDisplayName#,
    #ApplicationKey#,
    #ApplicationSecret#,
    #PinYin#,
    #Description#,
    #AdministratorEmail#
    #IconPath#,
    #BigIconPath#,
    #HelpUrl#,
    #LicenseStatus#,
    #Hidden#,
    #Locking#,
    #OrderId#,
    #Status#,
    #Remark#,
    CURRENT_TIMESTAMP,
    CURRENT_TIMESTAMP
    )
  </insert>
  <update id="Update" parameterType="com.x3platform.apps.models.ApplicationInfo" >
    UPDATE tb_Application SET

    ParentId = #ParentId#,
    Code = #Code#,
    ApplicationName = #ApplicationName#,
    ApplicationDisplayName = #ApplicationDisplayName#,
    ApplicationKey = #ApplicationKey#,
    ApplicationSecret = #ApplicationSecret#,
    PinYin = #PinYin#,
    Description = #Description#,
    AdministratorEmail = #AdministratorEmail#,
    IconPath = #IconPath#,
    BigIconPath = #BigIconPath#,
    HelpUrl = #HelpUrl#,
    LicenseStatus = #LicenseStatus#,
    Hidden = #Hidden#,
    Locking = #Locking#,
    OrderId = #OrderId#,
    Status = #Status#,
    Remark = #Remark#,
    ModifiedDate = CURRENT_TIMESTAMP

    WHERE Id = #Id# AND ModifiedDate = #ModifiedDate#
  </update>
  <!--
      <update id="Sync_HasChildren" >
          CREATE TEMPORARY TABLE tmp (Id VARCHAR(36) PRIMARY KEY, ParentId VARCHAR(36), Status INT);

          INSERT INTO tmp SELECT Id, ParentId, Status FROM tb_Application;

          UPDATE tb_Application SET HasChildren = (
            SELECT CASE COUNT(Id) WHEN  0 THEN 0 ELSE 1 END
            FROM tmp WHERE tmp.ParentId = tb_Application.Id AND tmp.Status = 1) ;

          DROP TEMPORARY TABLE tmp;
      </update>
      -->
  <delete id="Delete">
    DELETE FROM tb_Application WHERE $WhereClause$
  </delete>
  <select id="FindOne" parameterType="com.x3platform.apps.models.ApplicationInfo" resultMap="FindOne_Result" >
    SELECT * FROM tb_Application WHERE Id = #Id#
  </select>
  <select id="FindOneByApplicationName" parameterType="com.x3platform.apps.models.ApplicationInfo" resultMap="FindOne_Result" >
    SELECT * FROM tb_Application WHERE ApplicationName = #ApplicationName#
  </select>
  <select id="IsExist" >
    SELECT COUNT(*) AS "Count" FROM tb_Application T WHERE $WhereClause$
  </select>
  <select id="HasAuthority" >
    SELECT COUNT(*) AS "Count" FROM view_AuthObject_Account View1, tb_Application_Scope Scope
    WHERE
    View1.AccountId = #AccountId#
    AND View1.AuthorizationObjectId = Scope.AuthorizationObjectId
    AND View1.AuthorizationObjectType = Scope.AuthorizationObjectType
    AND Scope.AuthorityId = #AuthorityId#
    AND Scope.ApplicationId = #ApplicationId#
  </select>
  <insert id="AddAuthorizationScopeObject">
    INSERT INTO tb_Application_Scope
    (AuthorizationObjectType, AuthorizationObjectId, AuthorityId, ApplicationId, ModifiedDate, CreatedDate)

    VALUES
    (#AuthorizationObjectType#, #AuthorizationObjectId#, #AuthorityId#, #ApplicationId#, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
  </insert>
  <delete id="RemoveAuthorizationScopeObjects">
    DELETE FROM tb_Application_Scope WHERE ApplicationId = #ApplicationId# AND AuthorityId = #AuthorityId#
  </delete>
  <select id="GetAuthorizationScopeObjects" >
    SELECT * FROM tb_Application_Scope T WHERE ApplicationId = #ApplicationId# AND AuthorityId = #AuthorityId#
  </select>
  <insert id="SyncFromPackPage" parameterType="com.x3platform.apps.models.ApplicationInfo" >
    IF EXISTS(SELECT 0 FROM tb_Application WHERE Id = #Id#)
    BEGIN
    UPDATE tb_Application SET

    ParentId = #ParentId#,
    Code = #Code#,
    ApplicationName = #ApplicationName#,
    ApplicationDisplayName = #ApplicationDisplayName#,
    ModifiedDate = CURRENT_TIMESTAMP

    WHERE Id = #Id#
    END
    ELSE
    BEGIN
    INSERT INTO tb_Application
    (
    Id,
    AccountId,
    ParentId,
    Code,
    ApplicationName,
    ApplicationDisplayName,
    ApplicationKey,
    ApplicationSecret,
    PinYin,
    Description,
    AdministratorEmail,
    IconPath,
    BigIconPath,
    HelpUrl,
    LicenseStatus,
    Hidden,
    Locking,
    OrderId,
    Status,
    Remark,
    ModifiedDate,
    CreatedDate
    )
    VALUES
    (
    #Id#,
    #AccountId#,
    #ParentId#,
    #Code#,
    #ApplicationName#,
    #ApplicationDisplayName#,
    #ApplicationKey#,
    #ApplicationSecret#,
    #PinYin#,
    #Description#,
    #AdministratorEmail#,
    #IconPath#,
    #BigIconPath#,
    #HelpUrl#,
    #LicenseStatus#,
    #Hidden#,
    #Locking#,
    #OrderId#,
    #Status#,
    #Remark#,
    CURRENT_TIMESTAMP,
    CURRENT_TIMESTAMP
    )
    END
  </insert>
</mapper>
