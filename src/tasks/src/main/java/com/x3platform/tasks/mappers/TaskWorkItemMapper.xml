<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.x3platform.tasks.mappers.TaskWorkItemMapper">

  <resultMap id="task" type="com.x3platform.tasks.models.TaskWorkitemModel"></resultMap>
  <resultMap id="findOne_Result" type="com.x3platform.tasks.models.TaskWorkItemInfo">
    <result property="mId" column="id" />
    <result property="mApplicationId" column="application_id" />
    <result property="mTaskCode" column="task_code" />
    <result property="mType" column="type" />
    <result property="mTitle" column="title" />
    <result property="mContent" column="content" />
    <result property="mTags" column="tags" />
    <result property="mSenderId" column="sender_id" />
    <result property="mReceiverId" column="receiver_id" />
    <result property="mStatus" column="status" />
    <result property="mIsRead" column="is_read" />
    <result property="mFinishTime" column="finish_time" />
    <result property="mCreatedDate" column="created_date" />
  </resultMap>
  <resultMap id="findAll_Result" type="com.x3platform.tasks.models.TaskWorkItemInfo">
    <result property="mId" column="id" />
    <result property="mApplicationId" column="application_id" />
    <result property="mTaskCode" column="task_code" />
    <result property="mType" column="type" />
    <result property="mTitle" column="title" />
    <result property="mContent" column="content" />
    <result property="mTags" column="tags" />
    <result property="mSenderId" column="sender_id" />
    <result property="mReceiverId" column="receiver_id" />
    <result property="mStatus" column="status" />
    <result property="mIsRead" column="is_read" />
    <result property="mFinishTime" column="finish_time" />
    <result property="mCreatedDate" column="created_date" />
  </resultMap>

  <!--待优化(具体需要字段)，查询出对应id待办信息的详情-->
  <select id="selectTask" parameterType="string" resultType="com.x3platform.tasks.models.TaskWorkitemModel">
    SELECT * FROM task_workitem WHERE id=#{id}
  </select>

  <!--待确定需要字段,查询出所有对应接收人的待办信息-->
  <select id="queryAllTasK" parameterType="string" resultMap="task">
    SELECT id,title,content,created_date,is_read,type FROM task_workitem WHERE receiver_id=#{receiver_id} AND status!=1
  </select>

  <!--统计有多少需要处理的消息的条数-->
  <select id="countTask" parameterType="string" resultType="_int">
    SELECT COUNT(id) FROM task_workitem WHERE receiver_id=#{receiver_id} AND status!=1
  </select>

  <!--修改待办信息的阅读状态-->
  <update id="updateRead" parameterType="string">
    UPDATE task_workitem SET is_read=1 WHERE id=#{id}
  </update>


  <!--清楚操作，改变status的值-->
  <!--<update id="clearTask" parameterType="string">-->
  <!--UPDATE task_workitem SET status=1 WHERE type=#{type}-->
  <!--</update>-->

  <!--完成任务-->
  <update id="updateStatus" parameterType="string">
    UPDATE task_workitem SET status=1 WHERE id=#{id}
  </update>

  <!--<delete id="delTaskWorkitem" parameterType="string">-->
  <!--DELETE FROM task_workitem WHERE id=#{id}-->
  <!--</delete>-->

  <!--添加待办信息-->
  <insert id="addTask" parameterType="com.x3platform.tasks.models.TaskWorkitemModel">
    INSERT INTO task_workitem (id,application_id,task_code,type,title,content,tags,sender_id,receiver_id,is_read,status,finish_time,created_date)
    VALUES (#{id},#{application_id},#{task_code},#{type},#{title},#{content},#{tags},#{sender_id},#{receiver_id},0,0,#{finish_time},#{created_date})
  </insert>

  <select id="findOne" resultMap="findOne_Result" >
    SELECT * FROM Task_WorkItem T WHERE Id = #{taskId} AND ReceiverId = #{receiverId}
  </select>
  <select id="findAll" resultMap="findAll_Result" >
    SELECT * FROM task_workitem T

    <where>
      receiver_id = #{receiverId}
    </where>
    <if test="orderBy != null and orderBy !=''">
      ORDER BY ${orderBy}
    </if>
    <if test="length > 0">
      LIMIT 0, ${length}
    </if>
  </select>
  <select id="getUnfinishedQuantities" resultType="java.util.Map">
    SELECT CONVERT(INT, Type) AS 'type', COUNT(*) AS 'count'
      FROM task_workitem
    WHERE receiver_id = #{receiverId} AND status = 0
    GROUP BY Type
    ORDER BY Type
  </select>
  <select id="getUnfinishedQuantities" resultType="java.util.Map" databaseId="mysql">
    SELECT CONVERT(Type, SIGNED) AS 'type', COUNT(*) AS 'count'
    FROM task_workitem
    WHERE receiver_id = #{receiverId} AND status = 0
    GROUP BY Type
    ORDER BY Type
  </select>
</mapper>
