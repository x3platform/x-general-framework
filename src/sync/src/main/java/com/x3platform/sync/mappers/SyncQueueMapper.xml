<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.x3platform.sync.mappers.SyncQueueMapper">
  <resultMap id="BaseResultMap" type="com.x3platform.sync.models.SyncQueue">
    <result property="id" jdbcType="VARCHAR" column="id"/>
    <result property="applicationId" jdbcType="VARCHAR" column="application_id"/>
    <result property="queueName" jdbcType="VARCHAR" column="queue_name"/>
    <result property="priority" jdbcType="INTEGER" column="priority"/>
    <result property="lastPkgId" jdbcType="VARCHAR" column="last_pkg_id"/>
    <result property="orderId" jdbcType="VARCHAR" column="order_id"/>
    <result property="status" jdbcType="INTEGER" column="status"/>
    <result property="modifiedDate" jdbcType="TIMESTAMP" column="modified_date"/>
    <result property="createdDate" jdbcType="TIMESTAMP" column="created_date"/>
  </resultMap>
  <sql id="Select_Where_Clause">
    <where>
      <!-- 默认查询场景 -->
      <if test="var_scene == 'default'">
        <if test="param_id != null and param_id != ''">
          AND t.id = #{param_id}
        </if>
        <if test="param_application_id != null and param_application_id != ''">
          AND t.application_id = #{param_application_id}
        </if>
        <if test="param_queue_name != null and param_queue_name != ''">
          AND t.queue_name = #{param_queue_name}
        </if>
        <if test="param_priority != null">
          AND t.priority = #{param_priority}
        </if>
        <if test="param_last_pkg_id != null and param_last_pkg_id != ''">
          AND t.last_pkg_id = #{param_last_pkg_id}
        </if>
        <if test="param_order_id != null and param_order_id != ''">
          AND t.order_id = #{param_order_id}
        </if>
        <if test="param_status != null">
          AND t.status = #{param_status}
        </if>
        <if test="param_modified_date != null">
          AND t.modified_date = #{param_modified_date}
        </if>
        <if test="param_created_date != null">
          AND t.created_date = #{param_created_date}
        </if>
      </if>
    </where>
  </sql>
  <insert id="insert" parameterType="com.x3platform.sync.models.SyncQueue">
    INSERT INTO sync_queue
    (
      id,
      application_id,
      queue_name,
      priority,
      last_pkg_id,
      order_id,
      status,
      modified_date,
      created_date
    )
    VALUES
      (
        #{id,jdbcType=VARCHAR},
        #{applicationId,jdbcType=VARCHAR},
        #{queueName,jdbcType=VARCHAR},
        #{priority,jdbcType=INTEGER},
        #{lastPkgId,jdbcType=VARCHAR},
        #{orderId,jdbcType=VARCHAR},
        #{status,jdbcType=INTEGER},
        CURRENT_TIMESTAMP,
        CURRENT_TIMESTAMP
      )
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.x3platform.sync.models.SyncQueue">
    UPDATE sync_queue
    SET
      application_id = #{applicationId,jdbcType=VARCHAR},
      queue_name     = #{queueName,jdbcType=VARCHAR},
      priority       = #{priority,jdbcType=INTEGER},
      last_pkg_id    = #{lastPkgId,jdbcType=VARCHAR},
      order_id       = #{orderId,jdbcType=VARCHAR},
      status         = #{status,jdbcType=INTEGER},
      modified_date  = CURRENT_TIMESTAMP

    WHERE id = #{id}
  </update>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    DELETE FROM sync_queue
    WHERE id = #{id}
  </delete>
  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="BaseResultMap">
    SELECT *
    FROM sync_queue
    WHERE id = #{id}
  </select>
  <select id="findAll" parameterType="java.util.Map" resultMap="BaseResultMap">
    SELECT * FROM sync_queue t
    <if test="_parameter != null">
      <include refid="Select_Where_Clause"/>
    </if>
    <if test="orders != null and orders.size() > 0">
      ORDER BY
      <foreach collection="orders" item="order" index="index" separator=",">
        ${order}
      </foreach>
    </if>
    <if test="length > 0">
      LIMIT 0, ${length}
    </if>
  </select>
  <select id="isExist" resultType="java.lang.Boolean">
    SELECT COUNT(0) AS "Count"
    FROM sync_queue
    WHERE id = #{id}
  </select>
  <select id="getQueues" resultMap="BaseResultMap">
    SELECT *
    FROM sync_queue
    WHERE status = 1
    ORDER BY priority, order_id
  </select>
  <select id="getApplicationIds" resultType="java.lang.String">
    SELECT application_id
    FROM sync_queue
    WHERE status = 1
    GROUP BY application_id
  </select>
  <update id="setLastPkgId">
    UPDATE sync_queue
    SET
      last_pkg_id = #{last_pkg_id}

    WHERE id = #{id}
  </update>
</mapper>
